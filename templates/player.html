<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.png') }}" type="image/x-icon">
  <title>{{ song.title }} - Player</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/player.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
 <style>
  
    /* === Floating Playlist Dropdown on Right === */
    .playlist-wrapper {
      position: fixed;
      top: 55%;
      right: 20%;
      transform: translateY(-50%);
      background: rgba(25, 25, 25, 0.95);
      border-radius: 15px;
      border: 1px solid #00bfff33;
      padding: 15px;
      width: 250px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 0 25px rgba(0,191,255,0.25);
      display: none;
      z-index: 100;
      animation: slideInRight 0.3s ease-out;
      backdrop-filter: blur(8px);
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translate(20px, -50%); }
      to { opacity: 1; transform: translate(0, -50%); }
    }

    .playlist-wrapper button {
      display: block;
      width: 100%;
      background: none;
      border: none;
      color: white;
      padding: 8px 10px;
      text-align: left;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }

    .playlist-wrapper button:hover {
      background: rgba(0,191,255,0.25);
      transform: scale(1.03);
    }

    .playlist-wrapper .added {
      color: #00ff88;
    }

    .playlist-wrapper p {
      color: #999;
      text-align: center;
    }

    .playlist-add {
      text-align: center;
      margin-top: 15px;
    }

    .playlist-add button {
      background: linear-gradient(90deg, #00bfff, #0099ff);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 18px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .playlist-add button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(0,191,255,0.3);
    }

    #playlistSuccess {
      display: none;
      justify-content: center;
      align-items: center;
      color: #00ff88;
      font-weight: 600;
      font-size: 0.95rem;
      margin-top: 10px;
      background: rgba(0,255,136,0.1);
      border: 1px solid #00ff88;
      border-radius: 8px;
      padding: 6px 10px;
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
    }

    @keyframes successFade {
      0% { opacity: 0; transform: translateY(-10px); }
      20% { opacity: 1; transform: translateY(0); }
      80% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-10px); }
    }
.player-card {
  position: relative;
  width: 340px;
  padding: 25px;
  border-radius: 40px;
  background: linear-gradient(180deg, #111 0%, #0d0d0d 100%);
  box-shadow: 0 0 25px rgba(0, 0, 0, 0.6);
  overflow: hidden;
  margin: 40px auto;
  text-align: center;
  animation: floatCard 6s ease-in-out infinite alternate;
  transition: transform 0.3s ease;
}
@keyframes floatCard {
  0% { transform: translateY(0px); }
  100% { transform: translateY(-10px); }
}
/* ===== PLAYER CARD (Animated + Genre-based) ===== */
.player-card {
  position: relative;
  width: 340px;
  padding: 25px;
  border-radius: 40px;
  background: linear-gradient(180deg, #111 0%, #0d0d0d 100%);
  box-shadow: 0 0 25px rgba(0, 0, 0, 0.6);
  overflow: hidden;
  margin: 40px auto;
  text-align: center;
  animation: floatCard 6s ease-in-out infinite alternate;
  transition: transform 0.3s ease;
}

@keyframes floatCard {
  0% { transform: translateY(0px); }
  100% { transform: translateY(-10px); }
}

<style>
/* ===== PLAYER CARD (Animated + Genre-based) ===== */
.player-card {
  position: relative;
  width: 340px;
  padding: 25px;
  border-radius: 40px;
  background: linear-gradient(180deg, #111 0%, #0d0d0d 100%);
  box-shadow: 0 0 25px rgba(0, 0, 0, 0.6);
  overflow: hidden;
  margin: 40px auto;
  text-align: center;
  animation: floatCard 6s ease-in-out infinite alternate;
  transition: transform 0.3s ease;
}

@keyframes floatCard {
  0% { transform: translateY(0px); }
  100% { transform: translateY(-10px); }
}

.player-card:hover {
  transform: scale(1.03);
}

/* === Animated Layers === */
.player-card::before,
.player-card::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 50px;
  z-index: 0;
  transition: all 1s ease-in-out;
}

.player-card::before {
  inset: -6px;
  filter: blur(10px);
  opacity: 1;
  animation: rotateGlow 8s linear infinite;
}

.player-card::after {
  background-size: 100% 300%;
  opacity: 1;
  animation: colorWaves 6s ease-in-out infinite alternate;
}

/* === Floating Gradient Animations === */
@keyframes rotateGlow {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes colorWaves {
  0% { background-position: 0% 0%; }
  100% { background-position: 0% 100%; }
}

.player-card * {
  position: relative;
  z-index: 2;
}

/* === GENRE COLOR THEMES === */

/* üé∂ LO-FI ‚Äî Dreamy pastel tones */
.player-card.lofi::before,
.player-card.lo-fi::before {
  background: conic-gradient(
    from 0deg,
    #6dd5fa,
    #cc99ff,
    #f7797d,
    #84fab0,
    #6dd5fa
  );
}

.player-card.lofi::after,
.player-card.lo-fi::after {
  background: linear-gradient(
    180deg,
    rgba(173, 216, 230, 0.35),
    rgba(204, 153, 255, 0.35),
    rgba(247, 121, 125, 0.3),
    rgba(132, 250, 176, 0.3)
  );
}


/* üé∏ ROCK ‚Äî Red-orange flames */
.player-card.rock::before {
  background: conic-gradient(from 0deg, #ff0000, #ff6600, #ff3300, #660000, #ff0000);
}
.player-card.rock::after {
  background: linear-gradient(180deg,
    rgba(255, 0, 0, 0.35),
    rgba(255, 102, 0, 0.3),
    rgba(100, 0, 0, 0.3)
  );
}

/* üéµ ACOUSTIC ‚Äî Earthy greens and sunlight */
.player-card.acoustic::before {
  background: conic-gradient(from 0deg, #00ff88, #aaff00, #ffee00, #00ff88);
}
.player-card.acoustic::after {
  background: linear-gradient(180deg,
    rgba(0, 255, 136, 0.35),
    rgba(255, 238, 0, 0.3),
    rgba(170, 255, 0, 0.25)
  );
}

/* ‚ö° EDM ‚Äî Electric neon blues and pinks */
.player-card.edm::before {
  background: conic-gradient(from 0deg, #00fff2, #ff00de, #0077ff, #00fff2);
}
.player-card.edm::after {
  background: linear-gradient(180deg,
    rgba(0, 255, 242, 0.35),
    rgba(255, 0, 222, 0.3),
    rgba(0, 119, 255, 0.3)
  );
}

/* üé§ POP ‚Äî Bright and energetic pinks, oranges */
.player-card.pop::before {
  background: conic-gradient(from 0deg, #ff00c8, #ff7b00, #fffb00, #ff00c8);
}
.player-card.pop::after {
  background: linear-gradient(180deg,
    rgba(255, 0, 200, 0.35),
    rgba(255, 123, 0, 0.3),
    rgba(255, 255, 0, 0.25)
  );
}

/* üï∂Ô∏è HIP-HOP ‚Äî Royal purples and golden hues */
.player-card.hiphop::before {
  background: conic-gradient(from 0deg, #ffcc00, #7a00ff, #ff8800, #ffcc00);
}
.player-card.hiphop::after {
  background: linear-gradient(180deg,
    rgba(255, 204, 0, 0.35),
    rgba(122, 0, 255, 0.3),
    rgba(255, 136, 0, 0.25)
  );
}

/* === HOVER FADE TO BLACK === */
.player-card:hover::before,
.player-card:hover::after {
  opacity: 0;
  filter: blur(0px);
  transition: opacity 0.6s ease, filter 0.6s ease;
}

.player-card::before,
.player-card::after {
  transition: opacity 0.6s ease, filter 0.6s ease;
}

.player-card:hover {
  background: #000 !important;
  transform: scale(1.03);
  transition: background 0.6s ease, transform 0.3s ease;
}
</style>


  </style>
</head>

<body>
  <!-- Sidebar -->
<div class="sidebar">
  <div class="features">
    <div class="feature" onclick="window.location.href='/playlists'">
      <span>Playlists</span>
    </div>
    <div class="feature" onclick="window.location.href='/emotion'">
      <span>Facial Recommendation  </span>
    </div>
  </div>
</div>

  <!-- Header -->
  <header class="header-bar">
    <a class="logo" href="{{ url_for('index') }}">SoundStream</a>
    <div class="profile-container">
      {% if 'user' in session %}
      <div class="profile-wrapper">
        <img src="{{ url_for('static', filename='images/profile_icon.png') }}" alt="Profile" class="profile-img">
        <span class="profile-text">Hello, {{ session['user'] }} üëã</span>
        <div class="dropdown"><a href="{{ url_for('logout') }}">Logout</a></div>
      </div>
      {% endif %}
    </div>
  </header>

  <!-- Main Player -->
  <div class="main">
    <div class="main-container">
      <form class="search-container" action="/search" method="get">
        <input type="text" name="query" placeholder="Search for songs or artists..." required>
        <button type="submit">üîç</button>
      </form>

<div class="player-card {{ song.genre|lower }}">
  <img src="{{ url_for('static', filename='images/' + song.image) }}" alt="{{ song.title }}" class="album-art">
  <h2>{{ song.title }}</h2>
  <p>{{ song.artist }}</p>

  <!-- Controls -->
  <div class="controls">
    <button class="control-btn" onclick="prevSong()">‚èÆ</button>
    <button id="repeatBtn" class="control-btn" onclick="toggleRepeat()">üîÅ</button>
    <button id="playBtn" class="control-btn">‚ñ∂</button>
    <button class="control-btn" onclick="nextSong()">‚è≠</button>
  </div>

  <!-- Add to Playlist Button -->
  <div class="playlist-add">
    <button id="playlistBtn">‚ûï Add to Playlist</button>
    <div id="playlistSuccess">‚úÖ Added to Playlist!</div>
  </div>

  <!-- Timeline -->
  <div class="timeline-container">
    <span id="currentTime">0:00</span>
    <input type="range" id="timeline" value="0" step="1">
    <span id="duration">0:00</span>
  </div>

  <audio id="audioPlayer" src="{{ url_for('static', filename='songs/' + song.file) }}"></audio>
</div>


      <!-- Recommended Songs -->
      <h3 style="margin-top: 40px;">Recommended Songs</h3>
      <div class="recommended-grid">
        {% for s in related[:12] %}
        <div class="song-card" onclick="window.location.href='/player/{{ s.id }}'">
          <img src="{{ url_for('static', filename='images/' + s.image) }}" alt="{{ s.title }}">
          <h4>{{ s.title }}</h4>
          <p>{{ s.artist }}</p>
        </div>
        {% endfor %}
      </div>

    </div>
  </div>

  <!-- Floating Playlist Dropdown -->
  <div id="playlistDropdown" class="playlist-wrapper">
    {% if user_playlists %}
      {% for p in user_playlists %}
        <button type="button"
                class="playlist-option {% if p['id'] in existing_playlists %}added{% endif %}"
                data-playlist-id="{{ p['id'] }}">
          {{ p['name'] }}{% if p['id'] in existing_playlists %} ‚úÖ{% endif %}
        </button>
      {% endfor %}
    {% else %}
      <p>No playlists yet! üéß</p>
    {% endif %}
  </div>

  <!-- JS -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const audio = document.getElementById("audioPlayer");
    const playBtn = document.getElementById('playBtn');
    const timeline = document.getElementById('timeline');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const songs = JSON.parse('{{ songs | tojson | safe }}');
    const songId = JSON.parse('{{ song.id | tojson | safe }}');
    let currentSongId = songId;

    let isRepeat = false;
    let isPlaying = false;
    const autoNextEnabled = true;

    // === Basic Player Controls ===
    playBtn.addEventListener('click', () => (!isPlaying ? audio.play() : audio.pause()));
    audio.addEventListener('play', () => { isPlaying = true; playBtn.textContent = '‚è∏'; });
    audio.addEventListener('pause', () => { isPlaying = false; playBtn.textContent = '‚ñ∂'; });

    window.toggleRepeat = () => {
      isRepeat = !isRepeat;
      document.getElementById("repeatBtn").classList.toggle('active', isRepeat);
    };

    window.nextSong = () => {
      const i = songs.findIndex(s => s.id === currentSongId);
      const next = (i + 1) % songs.length;
      localStorage.setItem('autoPlayNext', 'true');
      window.location.href = `/player/${songs[next].id}`;
    };

    window.prevSong = () => {
      const i = songs.findIndex(s => s.id === currentSongId);
      const prev = (i - 1 + songs.length) % songs.length;
      localStorage.setItem('autoPlayNext', 'true');
      window.location.href = `/player/${songs[prev].id}`;
    };

    audio.addEventListener('loadedmetadata', () => {
      timeline.max = Math.floor(audio.duration);
      durationEl.textContent = formatTime(audio.duration);
    });

    audio.addEventListener('timeupdate', () => {
      timeline.value = Math.floor(audio.currentTime);
      currentTimeEl.textContent = formatTime(audio.currentTime);
    });

    timeline.addEventListener('input', () => { audio.currentTime = timeline.value; });

    audio.addEventListener('ended', () => {
      if (isRepeat) { audio.currentTime = 0; audio.play(); }
      else if (autoNextEnabled) nextSong();
    });

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    if (localStorage.getItem('autoPlayNext') === 'true') {
      setTimeout(() => { audio.play(); localStorage.removeItem('autoPlayNext'); }, 400);
    }

    // === Playlist Dropdown Logic ===
    const btn = document.getElementById("playlistBtn");
    const dropdown = document.getElementById("playlistDropdown");
    const successBox = document.getElementById("playlistSuccess");

    btn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    });

    document.addEventListener("click", (e) => {
      if (!btn.contains(e.target) && !dropdown.contains(e.target))
        dropdown.style.display = "none";
    });

    // === Add to Playlist via AJAX ===
    document.querySelectorAll(".playlist-option").forEach(option => {
      option.addEventListener("click", async (e) => {
        e.preventDefault();
        const playlistId = option.dataset.playlistId;

        try {
          const res = await fetch(`/add_to_playlist/${songId}`, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ playlist_id: playlistId })
          });

          const result = await res.json();

          if (result.status === "success") {
            option.textContent = option.textContent.replace("‚úÖ", "") + " ‚úÖ";
            option.classList.add("added");
            showSuccess(result.message);
            dropdown.style.display = "none";
          } else if (result.status === "exists") {
            showSuccess("‚ö†Ô∏è Already in playlist!");
          } else {
            alert(result.message || "‚ùå Error adding to playlist");
          }
        } catch (err) {
          console.error("Error adding song:", err);
          alert("‚ùå Something went wrong!");
        }
      });
    });

    function showSuccess(msg) {
      successBox.textContent = msg;
      successBox.style.display = "flex";
      successBox.style.animation = "none";
      void successBox.offsetWidth;
      successBox.style.animation = "successFade 1.5s ease-in-out forwards";
      setTimeout(() => successBox.style.display = "none", 1500);
    }
  });
  </script>
</body>
</html>
