<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ song.title }} - Player</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/player.css') }}">
  <style>
    /* === Playlist Dropdown Positioned to Right === */
    .playlist-wrapper {
  position: fixed;
  top: 55%;
  right: 22%;  /* üëà Brings the box closer to the player */
  transform: translateY(-50%);
  background: rgba(25, 25, 25, 0.95);
  border-radius: 15px;
  border: 1px solid #00bfff33;
  padding: 15px;
  width: 250px;
  max-height: 300px;
  overflow-y: auto;
  box-shadow: 0 0 25px rgba(0,191,255,0.25);
  display: none;
  z-index: 100;
  animation: slideInRight 0.3s ease-out;
  backdrop-filter: blur(8px);
}


    @keyframes slideInRight {
      from { opacity: 0; transform: translate(20px, -50%); }
      to { opacity: 1; transform: translate(0, -50%); }
    }

    .playlist-wrapper button {
      display: block;
      width: 100%;
      background: none;
      border: none;
      color: white;
      padding: 8px 10px;
      text-align: left;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }

    .playlist-wrapper button:hover {
      background: rgba(0,191,255,0.25);
      transform: scale(1.03);
    }

    .playlist-wrapper p {
      color: #999;
      text-align: center;
    }

    .playlist-add {
      text-align: center;
      margin-top: 15px;
    }

    .playlist-add button {
      background: linear-gradient(90deg, #00bfff, #0099ff);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 18px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .playlist-add button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(0,191,255,0.3);
    }

    #playlistSuccess {
      display: none;
      justify-content: center;
      align-items: center;
      color: #00ff88;
      font-weight: 600;
      font-size: 0.95rem;
      margin-top: 10px;
      background: rgba(0,255,136,0.1);
      border: 1px solid #00ff88;
      border-radius: 8px;
      padding: 6px 10px;
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
    }

    @keyframes successFade {
      0% { opacity: 0; transform: translateY(-10px); }
      20% { opacity: 1; transform: translateY(0); }
      80% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-10px); }
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="features">
      <div class="feature" onclick="window.location.href='/playlists'">üéß Playlists</div>
      <div class="feature">‚≠ê Feature 2</div>
      <div class="feature">üìÇ Feature 3</div>
    </div>
  </div>

  <!-- Header -->
  <header class="header-bar">
    <a class="logo" href="{{ url_for('index') }}">üéµ MusicPlayer</a>
    <div class="profile-container">
      {% if 'user' in session %}
      <div class="profile-wrapper">
        <img src="{{ url_for('static', filename='images/profile_icon.png') }}" alt="Profile" class="profile-img">
        <span class="profile-text">Hello, {{ session['user'] }} üëã</span>
        <div class="dropdown"><a href="{{ url_for('logout') }}">Logout</a></div>
      </div>
      {% endif %}
    </div>
  </header>

  <!-- Main Player -->
  <div class="main">
    <div class="main-container">
      <form class="search-container" action="/search" method="get">
        <input type="text" name="query" placeholder="Search for songs or artists..." required>
        <button type="submit">üîç</button>
      </form>

      <div class="player-card">
        <img src="{{ url_for('static', filename='images/' + song.image) }}" alt="{{ song.title }}" class="album-art">
        <h2>{{ song.title }}</h2>
        <p>{{ song.artist }}</p>

        <!-- Controls -->
        <div class="controls">
          <button class="control-btn" onclick="prevSong()">‚èÆ</button>
          <button id="repeatBtn" class="control-btn" onclick="toggleRepeat()">üîÅ</button>
          <button id="playBtn" class="control-btn">‚ñ∂</button>
          <button class="control-btn" onclick="nextSong()">‚è≠</button>
        </div>

        <!-- Add to Playlist Button -->
        <div class="playlist-add">
          <button id="playlistBtn">‚ûï Add to Playlist</button>
          <div id="playlistSuccess">‚úÖ Added to Playlist!</div>
        </div>

        <!-- Timeline -->
        <div class="timeline-container">
          <span id="currentTime">0:00</span>
          <input type="range" id="timeline" value="0" step="1">
          <span id="duration">0:00</span>
        </div>

        <audio id="audioPlayer" src="{{ url_for('static', filename='songs/' + song.file) }}"></audio>
      </div>

      <!-- Recommended Songs -->
      <h3 style="margin-top: 40px;">Recommended Songs</h3>
      <div class="recommended-grid">
        {% for s in related[:12] %}
        <div class="song-card" onclick="window.location.href='/player/{{ s.id }}'">
          <img src="{{ url_for('static', filename='images/' + s.image) }}" alt="{{ s.title }}">
          <h4>{{ s.title }}</h4>
          <p>{{ s.artist }}</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Floating Playlist Dropdown (Right Side) -->
  <div id="playlistDropdown" class="playlist-wrapper">
    {% if user_playlists %}
      {% for p in user_playlists %}
      <form method="POST" action="/add_to_playlist/{{ song.id }}">
        <input type="hidden" name="playlist_id" value="{{ p['id'] }}">
        <button type="submit" class="playlist-option">{{ p['name'] }}</button>
      </form>
      {% endfor %}
    {% else %}
      <p>No playlists yet! üéß</p>
    {% endif %}
  </div>

  <!-- JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const audio = document.getElementById("audioPlayer");
  const playBtn = document.getElementById('playBtn');
  const timeline = document.getElementById('timeline');
  const currentTimeEl = document.getElementById('currentTime');
  const durationEl = document.getElementById('duration');
  const songs = JSON.parse('{{ songs | tojson | safe }}');
  const songId = JSON.parse('{{ song.id | tojson | safe }}');
  let currentSongId = songId;

  let isRepeat = false;
  let isPlaying = false;
  const autoNextEnabled = true;

  // === ‚ñ∂ Play / Pause ===
  playBtn.addEventListener('click', () => (!isPlaying ? audio.play() : audio.pause()));
  audio.addEventListener('play', () => { isPlaying = true; playBtn.textContent = '‚è∏'; });
  audio.addEventListener('pause', () => { isPlaying = false; playBtn.textContent = '‚ñ∂'; });

  // === üîÅ Repeat ===
  window.toggleRepeat = () => {
    isRepeat = !isRepeat;
    document.getElementById("repeatBtn").classList.toggle('active', isRepeat);
  };

  // === ‚èÆ / ‚è≠ ===
  window.nextSong = () => {
    const i = songs.findIndex(s => s.id === currentSongId);
    const next = (i + 1) % songs.length;
    localStorage.setItem('autoPlayNext', 'true');
    window.location.href = `/player/${songs[next].id}`;
  };

  window.prevSong = () => {
    const i = songs.findIndex(s => s.id === currentSongId);
    const prev = (i - 1 + songs.length) % songs.length;
    localStorage.setItem('autoPlayNext', 'true');
    window.location.href = `/player/${songs[prev].id}`;
  };

  // === Timeline ===
  audio.addEventListener('loadedmetadata', () => {
    timeline.max = Math.floor(audio.duration);
    durationEl.textContent = formatTime(audio.duration);
  });

  audio.addEventListener('timeupdate', () => {
    timeline.value = Math.floor(audio.currentTime);
    currentTimeEl.textContent = formatTime(audio.currentTime);
  });

  timeline.addEventListener('input', () => { audio.currentTime = timeline.value; });

  // === Auto Next ===
  audio.addEventListener('ended', () => {
    if (isRepeat) { audio.currentTime = 0; audio.play(); }
    else if (autoNextEnabled) nextSong();
  });

  // === Format Time ===
  function formatTime(sec) {
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  if (localStorage.getItem('autoPlayNext') === 'true') {
    setTimeout(() => { audio.play(); localStorage.removeItem('autoPlayNext'); }, 400);
  }

  // === üéß Playlist Dropdown ===
  const btn = document.getElementById("playlistBtn");
  const dropdown = document.getElementById("playlistDropdown");
  const successBox = document.getElementById("playlistSuccess");

  btn.addEventListener("click", async (e) => {
    e.preventDefault();
    e.stopPropagation();

    const isVisible = dropdown.style.display === "block";
    dropdown.style.display = isVisible ? "none" : "block";

    if (!isVisible) {
      // üß† Fetch which playlists already contain this song
      try {
        const res = await fetch(`/song_playlists/${songId}`);
        const songPlaylists = await res.json();

        document.querySelectorAll(".playlist-option").forEach(option => {
          const id = parseInt(option.dataset.playlistId);
          const mark = option.querySelector(".checkmark");
          if (songPlaylists.includes(id)) {
            mark.style.display = "inline";
            option.disabled = true;
          } else {
            mark.style.display = "none";
            option.disabled = false;
          }
        });
      } catch (err) {
        console.error("Failed to fetch playlist info:", err);
      }
    }
  });

  // === Close dropdown when clicking outside ===
  document.addEventListener("click", (e) => {
    if (!btn.contains(e.target) && !dropdown.contains(e.target)) dropdown.style.display = "none";
  });

  // === üé∂ Add Song to Playlist (AJAX) ===
  document.querySelectorAll(".playlist-option").forEach(option => {
    option.addEventListener("click", async (e) => {
      e.preventDefault();
      const playlistId = option.dataset.playlistId;

      try {
        const res = await fetch(`/add_to_playlist/${songId}`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ playlist_id: playlistId })
        });

        const result = await res.json();
        if (result.status === "success" || result.status === "exists") {
          // ‚úÖ Show success checkmark instantly
          option.querySelector(".checkmark").style.display = "inline";
          option.disabled = true;

          // üéâ Flash success animation
          successBox.style.display = "flex";
          successBox.style.animation = "none";
          void successBox.offsetWidth;
          successBox.style.animation = "successFade 1.5s ease-in-out forwards";
          setTimeout(() => successBox.style.display = "none", 1500);
        }
      } catch (err) {
        console.error("Add to playlist failed:", err);
        alert("‚ùå Something went wrong!");
      }
    });
  });
});
</script>

</body>
</html>
